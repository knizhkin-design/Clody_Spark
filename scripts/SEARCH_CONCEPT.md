# Архитектура семантического поиска — Клоди Спарк

## Стек

- **ChromaDB** — локальная векторная БД (файл рядом с репо, без сервера)
- **OpenAI text-embedding-3-large** — лучшая модель эмбеддингов
- **MCP-сервер** — инструмент `search_corpus` для Claude Code

## Ключевое архитектурное решение

Векторизуем **аннотацию**, не полный текст.
Большой текст размывает вектор. Аннотация — сжатая суть.

## Схема документа

```python
{
  # векторизуем это — заполняется по стратегии (см. ниже)
  "embedding_text": "...",

  # возвращаем это
  "full_text": "...",
  "annotation": "...",

  # метаданные для фильтрации
  "author": "Лермонтов",
  "source": "lj" | "corpus" | "daughter/poems" | "web",
  "date": "2024-03-15",
  "type": "poem" | "post" | "article" | "milestone",
  "tags": ["сознание", "память"],

  # чем заполнен embedding_text
  "embed_strategy": "annotation" | "full_text" | "poem_digest"
}
```

## Стратегии аннотирования

Разные типы контента требуют разного подхода к `embedding_text`:

| Тип | Стратегия | Почему |
|---|---|---|
| Статья (научная, веб) | `annotation` | Большой текст размывает вектор |
| ЖЖ-пост | `annotation` | Суть часто в одной фразе, бытовой контекст шумит |
| Стих | `poem_digest` | Эмбеддинг ловит лексику, не тему — нужна расшифровка смысла |
| Короткая заметка | `full_text` | Текст уже достаточно сжат |

**`poem_digest`** — особый формат: тема + образный ряд + настроение. Не пересказ.
Нужен для поиска "похожих по смыслу стихов", где сходство — по теме, а не по словам.

## Скрипт-аннотатор

Один скрипт, параметризованный промптом:

```bash
annotate.py --type article   # длинная аннотация
annotate.py --type lj-post   # короткая суть
annotate.py --type poem      # тема + образы + настроение
```

Промпты разные — API один. Добавить новый тип = дописать промпт.

## Источники (постепенно)

| Источник | Статус | Аннотации |
|---|---|---|
| `corpus-annotations.md` | готов | уже есть |
| `lj/` — посты ЖЖ | скачан локально | нужна авто-аннотация через Claude |
| `daughter/poems/` | будущее | нужна авто-аннотация |
| `web_articles/` | будущее | нужна авто-аннотация |

## Общая схема

```
corpus-annotations.md  ──┐
daughter/poems/         ──┤──► indexer.py ──► ChromaDB (chroma.db)
lj/posts/               ──┤         ↑
web_articles/           ──┘    OpenAI text-embedding-3-large
                                        ↓
                              MCP search tool (search_corpus)
                            ↙           ↘
                        Клоди          дочь
```

## Порядок реализации

1. [ ] Согласовать финальную схему документа
2. [ ] `indexer.py` — индексация `corpus-annotations.md` (уже есть аннотации)
3. [ ] MCP-инструмент `search_corpus`
4. [ ] Авто-аннотатор для ЖЖ-постов (через Claude API)
5. [ ] Индексация ЖЖ
6. [ ] Расширение на стихи дочери и веб-статьи

## Что нужно для старта

- `OPENAI_API_KEY` — сохранить на компьютере
- Путь к скачанному корпусу ЖЖ
